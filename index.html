<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test task 2 - Бурсервис</title>
    <link href="style.css" rel="stylesheet" />
</head>
<body>

    <h1>Задание "Таблоид".</h1>
    <div class="options">
        <label for="wordInput">Введите строку:</label>
        <input type="text" id="wordInput" value="Текст text 123"/>
    </div>
    <div class="options">
        <label for="pixelColor">Выберите цвет буквенных ячеек:</label>
        <input type="color" id="pixelColor" name="pixelColor">
        <br>
        <input type="checkbox" id="randomColor" name="randomColor">
        <label for="randomColor">Рандомайзер</label>
    </div>
    <div class="options">
        <label for="tabloidWidth">Введите ширину таблоида:</label>
        <input type="number" id="tabloidWidth" value="300"/>
        <br>
        <input type="checkbox" id="autoWidth" name="autoWidth">
        <label for="autoWidth">Неограниченный рост</label>
    </div>
    <div class="options">
        <label for="tabloidHeight">Введите высоту таблоида:</label>
        <input type="number" id="tabloidHeight" value="20"/>
        <br>
        <label for="letterHeight">Введите высоту буквы:</label>
        <input type="number" id="letterHeight" value="20"/>
        <br>
        <label for="letterWidth">Введите ширину буквы:</label>
        <input type="number" id="letterWidth"/>
        <br>
        <input type="checkbox" id="autoFontSize" name="autoFontSize">
        <label for="autoFontSize">Подгон букв под размер таблоида</label>
    </div>

    <button id="generateButton">Сгенерировать таблоид</button>

    <canvas hidden id="tabloidCanvas" width="10" height="10"></canvas>

    <div id="tabloid"></div>

    <script>
        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        randomColor.onchange = function () {
            pixelColor.disabled = randomColor.checked;
        };
        autoWidth.onchange = function () {
            tabloidWidth.disabled = autoWidth.checked;
        };
        autoFontSize.onchange = function () {
            letterWidth.disabled = autoFontSize.checked;
            letterHeight.disabled = autoFontSize.checked;
        };
        generateButton.onclick = function () {
            const canvas = document.getElementById('tabloidCanvas');
            const ctx = canvas.getContext('2d', { willReadFrequently: true });

            let widthRatio = 1;
            if (!autoFontSize.checked && !autoWidth.checked) {
                ctx.font = letterHeight.value+"px monospace";
                let metrics = ctx.measureText(wordInput.value);
                let normalTextWidth = metrics.width;
                if (!letterWidth.value)
                    letterWidth.value = Math.round(normalTextWidth / wordInput.value.length);
                let expectedTextWidth = wordInput.value.length * letterWidth.value;
                widthRatio = expectedTextWidth / normalTextWidth;

                ctx.canvas.height = tabloidHeight.value;
                ctx.canvas.width = tabloidWidth.value;
                ctx.font = letterHeight.value+"px monospace";
            }
            if (!autoFontSize.checked && autoWidth.checked) {
                ctx.font = letterHeight.value+"px monospace";
                let metrics = ctx.measureText(wordInput.value);
                let normalTextWidth = metrics.width;
                if (!letterWidth.value)
                    letterWidth.value = Math.round(normalTextWidth / wordInput.value.length);
                let expectedTextWidth = wordInput.value.length * letterWidth.value;
                widthRatio = expectedTextWidth / normalTextWidth;

                ctx.canvas.height = tabloidHeight.value;
                ctx.canvas.width = expectedTextWidth;
                ctx.font = letterHeight.value+"px monospace";
            }
            if (autoFontSize.checked && !autoWidth.checked) {
                letterHeight.value = tabloidHeight.value;
                ctx.font = letterHeight.value+"px monospace";
                let metrics = ctx.measureText(wordInput.value);
                let normalTextWidth = metrics.width;
                letterWidth.value = Math.round(tabloidWidth.value / wordInput.value.length);
                let expectedTextWidth = wordInput.value.length * letterWidth.value;
                widthRatio = expectedTextWidth / normalTextWidth;

                ctx.canvas.height = tabloidHeight.value;
                ctx.canvas.width = expectedTextWidth;
                ctx.font = letterHeight.value+"px monospace";
            }
            if (autoFontSize.checked && autoWidth.checked) {
                letterHeight.value = tabloidHeight.value;
                ctx.font = letterHeight.value+"px monospace";
                let metrics = ctx.measureText(wordInput.value);
                let normalTextWidth = metrics.width;
                letterWidth.value = Math.round(normalTextWidth / wordInput.value.length);
                let expectedTextWidth = wordInput.value.length * letterWidth.value;
                widthRatio = expectedTextWidth / normalTextWidth;

                ctx.canvas.height = tabloidHeight.value;
                ctx.canvas.width = expectedTextWidth;
                ctx.font = letterHeight.value+"px monospace";
            }

            ctx.scale(widthRatio,1);
            ctx.textBaseline = "top";
            ctx.fillText(wordInput.value, 0, 0);

            ctx.setTransform();

            tabloid.textContent = '';
            tabloid.style["grid-template-columns"] = "repeat(" + canvas.width + ",10px)";
            tabloid.style["grid-template-rows"] = "repeat(" + canvas.height + ",10px)";

            var id = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let i = 0
            while (i < id.data.length) {  // data - ОДНОМЕРНЫЕЙ массив с информацей о пикселах (rgba), информация о свете представляет из себя 4 подряд идущих элемента, являющихся компонентами цвета rgba. проходится по изображению слева направо, сверху вниз
                let cell = document.createElement("div");
                cell.classList.add("cell");
                if (id.data[i+3] !== 0) {  // пустая ячейка - альфа канал === 0
                    if (randomColor.checked) {
                        cell.style.backgroundColor = getRandomColor();
                    } else {
                        cell.style.backgroundColor = pixelColor.value;
                    }
                }
                tabloid.appendChild(cell);
                i += 4;
            }

        }
    </script>
</body>
</html>